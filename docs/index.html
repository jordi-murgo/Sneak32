<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake32 Manager</title>
    <style>
        /* Estilos base */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --background-color: #f4f4f4;
            --text-color: #333;
            --error-color: #e74c3c;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.2;
            color: var(--text-color);
            background-color: var(--background-color);
            padding-top: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px 20px;
        }

        /* Estilos de navegaci√≥n */
        nav {
            padding: 0;
        }

        nav ul {
            display: flex;
            list-style-type: none;
            padding: 0;
            margin: 0 10px 0 0;
        }

        nav ul li {
            margin: 1px;
        }

        nav ul li a {
            display: block;
            padding: 10px 20px;
            text-decoration: none;
            color: var(--text-color);
            background-color: #e0e0e0;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            transition: background-color 0.3s;
        }

        nav ul li a:hover {
            background-color: #d0d0d0;
        }

        nav ul li a.active {
            background-color: white;
            font-weight: bold;
            position: relative;
            z-index: 1;
        }

        /* Estilos de p√°gina */
        .page {
            display: none;
            padding: 20px;
            background-color: #f0f0f0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-top: -1px;
            border: 1px solid #ddd;
        }

        .page.active {
            display: grid;
            gap: 10px;
            background-color: white;
        }

        /* Estilos espec√≠ficos para la p√°gina de logon */
        #logon.active {
            border-radius: 5px;
            margin-top: 10px;
            border-top: 1px solid #ddd;
        }

        /* Ajuste para las otras p√°ginas */
        .page.active:not(#logon) {
            border-top: none;
        }

        /* Estilos espec√≠ficos de p√°gina */
        #logon {
            text-align: center;
            align-items: center;
        }

        #logon .logo {
            width: 330px;
            margin: 20px auto 0 auto;
            padding-left: 5px;
        }

        #searchDeviceBtn {
            display: inline-block;
            width: fit-content;
            margin: 0 auto;
        }


        /* Estilos de componentes */
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        /* Add this new style for save buttons */
        button.save-button {
            background-color: var(--secondary-color);
        }

        button.save-button:hover {
            background-color: #27ae60;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Estilos responsivos */
        @media (max-width: 300px) {
            nav ul {
                flex-direction: column;
                align-items: center;
            }

            nav ul li {
                margin: 5px 0;
            }

            .page {
                padding: 10px;
            }
        }

        /* Estilos para el modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 5px;
            text-align: center;
        }

        .modal-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #firmwareInfo {
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-top: 0px;
        }

        h3 {
            margin-top: 0px;
            margin-bottom: 0px;
            color: var(--primary-color);
            margin-block-start: 0em;
            margin-block-end: 0em;
        }

        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0px;
        }

        .app-title {
            color: var(--primary-color);
            font-size: 1.5em;
            margin: 0;
        }

        nav {
            flex-grow: 1;
            text-align: right;
        }

        nav ul {
            justify-content: flex-end;
        }

        .hidden {
            display: none !important;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 5px 10px;
            margin-bottom: 20px;

            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .settings-grid label {
            display: flex;
            align-items: center;
        }

        .settings-grid input,
        .settings-grid select {
            display: flex;
            align-items: center;
            width: fit-content;
        }

        .settings-grid input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            height: 20px;
            width: 20px;
        }

        #updateSettings {
            width: fit-content;
            margin-top: 10px;
        }



        .button-container {
            width: 100%;
            display: flex;
            justify-content: space-between;
        }

        .left-buttons {
            display: inline;
            gap: 10px;
            align-self: flex-start;
        }

        .right-buttons {
            display: flex;
            gap: 10px;
            align-self: flex-end;
        }

        #jsonViewer {
            clear: both;
            white-space: pre-wrap;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-top: 0px;
        }

        .json-key {
            color: #881391;
        }

        .json-string {
            color: #1A1AA6;
        }

        .json-number {
            color: #1E90FF;
        }

        .json-boolean {
            color: #228B22;
        }

        .json-null {
            color: #808080;
        }

        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
            /* Hide the progress bar container by default */
        }

        .progress-bar {
            width: 0;
            height: 20px;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.05s ease-in-out;
        }

        .tooltip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
            text-align: center;
            pointer-events: none;
        }

        .tooltip.show {
            opacity: 1;
        }

        #logContainer {
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-top: 0px;

            height: fit-content;
            max-height: 300px;
            overflow-y: auto;
        }

        #log {
            font-family: monospace;
            white-space: pre-wrap;
            margin: 0;
        }

        footer {
            text-align: center;
            padding: 10px;
            font-size: 0.8em;
        }

        #statusContainer {
            display: ruby;
            flex-direction: column;
            gap: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f0f0f0;
            padding: 10px;
            margin-bottom: 10px;
        }

        #status-alarm,
        #status-mode,
        #status-wifi-networks,
        #status-wifi-devices,
        #status-ble-devices {
            font-weight: bold;
            margin-right: 10px;
        }

        #operationContainer,
        #captureContainer,
        #detectionContainer {
            display: ruby;
            gap: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="header" class="hidden">
            <h1 class="app-title">üïµÔ∏è‚Äç‚ôÇÔ∏è Sneak32 Manager</h1>
            <nav>
                <ul>
                    <li><a href="#status">Status</a></li>
                    <li><a href="#setup">Setup</a></li>
                    <li><a href="#data-transfer">Data</a></li>
                </ul>
            </nav>
        </div>

        <div id="logon" class="page active">
            <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è Sneak32 Manager</h1>
            <img src="logo-esp32.png" alt="ESP32 Logo" class="logo">
            <button id="searchDeviceBtn">Search for Device</button>
        </div>

        <div id="status" class="page">
            <h3 id="statusTitle">Firmware Information:</h3>
            <div id="firmwareInfo"></div>

            <h3>Status:</h3>
            <div id="statusContainer">
                <label>Mode:</label>
                <div id="status-mode"></div>
                <label>Networks:</label>
                <div id="status-wifi-networks"></div>
                <label>Devices:</label>
                <div id="status-wifi-devices"></div>
                <label>BLE Devices:</label>
                <div id="status-ble-devices"></div>
                <label class="alarm">Alarm:</label>
                <div class="alarm" id="status-alarm"></div>
            </div>

            <div id="operationContainer">
                <button id="operationResetButton">Reset</button>
                <div id="captureContainer" class="hidden">
                    <button id="captureSwitchOffButton">Switch to OFF</button>
                    <button id="captureSwitchDetectionButton">Switch to Detection</button>
                    <button id="captureCleanSaveDataButton" class="save-button">Clean Capture</button>
                    <button id="captureSaveDataButton" class="save-button">Save Capture</button>
                </div>
                <div id="detectionContainer" class="hidden">
                    <button id="detectionSwitchOffButton">Switch to OFF</button>
                    <button id="detectionSwitchCaptureButton">Switch to Capture</button>
                    <button id="detectionCleanDataButton" class="save-button">Clean Detection</button>
                </div>
                <div id="offContainer" class="hidden">
                    <button id="offSwitchDetectionButton">Switch to Detection</button>
                    <button id="offSwitchCaptureButton">Switch to Capture</button>
                </div>
            </div>

            <h3>Event Log:</h3>
            <div id="logContainer"></div>
        </div>

        <div id="setup" class="page">
            <h2>Device Setup</h2>

            <h3>General</h3>
            <div class="settings-grid">
                <label for="deviceName">Device Name:</label>
                <input type="text" id="deviceName" maxlength="31">

                <label for="operationMode">Operation Mode:</label>
                <select id="operationMode">
                    <option value="0">OFF</option>
                    <option value="1">CAPTURE</option>
                    <option value="2">DETECTION</option>
                </select>

                <label for="autosaveInterval">Autosave Scanned Data (min):</label>
                <input type="number" id="autosaveInterval" min="0" max="9999">

                <label for="minimalRSSI">Minimal RSSI (dBm):</label>
                <input type="number" id="minimalRSSI" min="-100" max="0">

                <label for="passiveScan">Passive Scan:</label>
                <input type="checkbox" id="passiveScan">

                <label for="stealthMode">Stealth Mode:</label>
                <input type="checkbox" id="stealthMode">

            </div>

            <h3>WiFi</h3>
            <div class="settings-grid">
                <label for="loopDelay">WiFi Scan (ms):</label>
                <input type="number" id="loopDelay" min="100" max="60000" step="100">

                <label for="onlyManagementFrames">Only Mgmt Frames:</label>
                <input type="checkbox" id="onlyManagementFrames">
            </div>

            <h3>BLE</h3>
            <div class="settings-grid">
                <label for="bleScanPeriod">BLE Scan Period (ms):</label>
                <input type="number" id="bleScanPeriod" min="1000" max="60000" step="1000">

                <label for="bleScanDuration">BLE Scan Duration (s):</label>
                <input type="number" id="bleScanDuration" min="1" max="30" step="1">

                <label for="ignoreRandomBLE">Ignore Random BLE:</label>
                <input type="checkbox" id="ignoreRandomBLE">
            </div>

            <button id="updateSettingsButton" class="save-button">Update Settings</button>
        </div>

        <div id="data-transfer" class="page">
            <h2>Data Transfer</h2>
            <div id="listSizes"></div>
            <div class="button-container">
                <div class="left-buttons">
                    <button id="getDataButton">Get Data</button>
                    <button id="getRelevantDataButton">Get Relevant Data</button>
                    <button id="saveDataButton" class="save-button">Save Data</button>
                    <button id="saveRelevantDataButton" class="save-button">Save Relevant Data</button>
                </div>
                <div class="right-buttons">
                    <button id="copyButton">Copy to Clipboard</button>
                </div>
            </div>
            <div class="progress-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="jsonViewer"></div>
        </div>
    </div>

    <div id="disconnectionModal" class="modal">
        <div class="modal-content">
            <p>The BLE connection was unexpectedly closed. Please reconnect.</p>
            <button class="modal-button" onclick="closeModal()">OK</button>
        </div>
    </div>

    <footer>
        &copy; 2024 Jordi Murgo. All rights reserved.
    </footer>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SNEAK32_SERVICE_UUID = "81af4cd7-e091-490a-99ee-caa99032ef4e";
            const FIRMWARE_INFO_UUID = 0xFFE3;
            const SETTINGS_UUID = 0xFFE2;
            const DATATRANSFER_UUID = 0xFFE0;
            const COMMANDS_UUID = 0xFFE4;
            const STATUS_UUID = 0xFFE1;
            const searchDeviceBtn = document.getElementById('searchDeviceBtn');
            const headerElement = document.getElementById('header');
            const firmwareInfoElement = document.getElementById('firmwareInfo');
            const statusTitleElement = document.getElementById('statusTitle');

            let bluetoothDevice;
            let bluetoothServer;
            let firmwareInfoCharacteristic;
            let settingsCharacteristic;
            let dataTransferCharacteristic;
            let commandsCharacteristic;
            let statusCharacteristic;
            const updateSettingsButton = document.getElementById('updateSettingsButton');

            const getDataButton = document.getElementById('getDataButton');
            const getRelevantDataButton = document.getElementById('getRelevantDataButton');
            const jsonViewer = document.getElementById('jsonViewer');

            const saveDataButton = document.getElementById('saveDataButton');
            const copyButton = document.getElementById('copyButton');
            const saveRelevantDataButton = document.getElementById('saveRelevantDataButton');
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.querySelector('.progress-container');

            const offSwitchDetectionButton = document.getElementById('offSwitchDetectionButton');
            const offSwitchCaptureButton = document.getElementById('offSwitchCaptureButton');   
            const captureCleanSaveDataButton = document.getElementById('captureCleanSaveDataButton');
            const captureSaveDataButton = document.getElementById('captureSaveDataButton');
            const captureSwitchDetectionButton = document.getElementById('captureSwitchDetectionButton');
            const captureSwitchOffButton = document.getElementById('captureSwitchOffButton');
        
            const detectionCleanDataButton = document.getElementById('detectionCleanDataButton');
            const detectionSwitchCaptureButton = document.getElementById('detectionSwitchCaptureButton');
            const detectionSwitchOffButton = document.getElementById('detectionSwitchOffButton');
        
            const resetButton = document.getElementById('resetButton');

            const operationContainer = document.getElementById('operationContainer');
            const captureContainer = document.getElementById('captureContainer');
            const detectionContainer = document.getElementById('detectionContainer');
            const offContainer = document.getElementById('offContainer');

            let totalPackets = 0;
            let currentPacket = 0;
            let receivedData = '';


            const logContainer = document.getElementById('logContainer');

            let statusInterval;

            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');

                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }

            function addLog(message, isError = false) {
                const now = new Date();
                const timestamp = now.toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}`;

                const newLogEntry = document.createElement('div');
                newLogEntry.textContent = logMessage;
                if (isError) {
                    newLogEntry.classList.add('error-log');
                }
                logContainer.appendChild(newLogEntry);

                // Usar setTimeout para asegurar que el DOM se ha actualizado
                setTimeout(() => {
                    logContainer.scrollTop = logContainer.scrollHeight;
                }, 0);
            }

            async function connectToBLEDevice() {
                try {
                    addLog('Searching for BLE devices...');

                    bluetoothDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ services: [SNEAK32_SERVICE_UUID] }],
                        optionalServices: [FIRMWARE_INFO_UUID, SETTINGS_UUID, DATATRANSFER_UUID, COMMANDS_UUID, STATUS_UUID]
                    });

                    addLog('Connecting...');
                    showPage('#status');
                    updateStatusTitle(`${bluetoothDevice.name}`);
                    addLog(`Connected to ${bluetoothDevice.name}`);
                    showTooltip(`Retrieving data from ${bluetoothDevice.name}`);

                    bluetoothServer = await bluetoothDevice.gatt.connect();

                    bluetoothDevice.addEventListener('gattserverdisconnected', handleDisconnection);


                    const service = await bluetoothServer.getPrimaryService(SNEAK32_SERVICE_UUID);
                    firmwareInfoCharacteristic = await service.getCharacteristic(FIRMWARE_INFO_UUID);
                    settingsCharacteristic = await service.getCharacteristic(SETTINGS_UUID);
                    dataTransferCharacteristic = await service.getCharacteristic(DATATRANSFER_UUID);
                    commandsCharacteristic = await service.getCharacteristic(COMMANDS_UUID);
                    statusCharacteristic = await service.getCharacteristic(STATUS_UUID);

                    await readFirmwareInfo();
                    await readSettings();
                    await readStatus();

                    // Start periodic status updates
                    statusInterval = setInterval(readStatus, 30000);

                    searchDeviceBtn.style.display = 'none';
                    headerElement.classList.remove('hidden');

                    await dataTransferCharacteristic.startNotifications();
                    dataTransferCharacteristic.addEventListener('characteristicvaluechanged', handleDataTransferNotification);

                    await statusCharacteristic.startNotifications();
                    statusCharacteristic.addEventListener('characteristicvaluechanged', handleStatusNotification);

                } catch (error) {
                    console.error('Error:', error);
                    addLog(`Error: ${error.message}`, true);
                    showPage('#logon');
                }
            }

            async function readFirmwareInfo() {
                try {
                    const value = await firmwareInfoCharacteristic.readValue();
                    const decoder = new TextDecoder('utf-8');
                    const firmwareInfo = decoder.decode(value);
                    firmwareInfoElement.textContent = firmwareInfo;
                    addLog('Firmware info read successfully');
                } catch (error) {
                    console.error('Error reading firmware info:', error);
                    addLog(`Error reading firmware info: ${error.message}`, true);
                }
            }

            // Default settings, overwritten by the device settings
            const settings = {
                onlyManagementFrames: false,
                minimalRSSI: -60,
                loopDelay: 100,
                bleScanPeriod: 1000,
                ignoreRandomBLE: false,
                bleScanDuration: 10,
                operationMode: 0,
                passiveScan: false,
                stealthMode: false,
                autosaveInterval: 10,
                deviceName: "Sneak32",
            }

            async function readSettings() {
                try {
                    const value = await settingsCharacteristic.readValue();
                    const settingsString = new TextDecoder().decode(value);

                    const parts = settingsString.split(':');

                    settings.onlyManagementFrames = parts[0] === '1';
                    settings.minimalRSSI = parseInt(parts[1]);
                    settings.loopDelay = parseInt(parts[2]);
                    settings.bleScanPeriod = parseInt(parts[3]);
                    settings.ignoreRandomBLE = parts[4] === '1';
                    settings.bleScanDuration = parseInt(parts[5]);
                    settings.operationMode = parseInt(parts[6]);
                    settings.passiveScan = parts[7] === '1';
                    settings.stealthMode = parts[8] === '1';
                    settings.autosaveInterval = parseInt(parts[9]);
                    settings.deviceName = parts.slice(10).join(':');

                    document.getElementById('onlyManagementFrames').checked = settings.onlyManagementFrames;
                    document.getElementById('minimalRSSI').value = settings.minimalRSSI;
                    document.getElementById('loopDelay').value = settings.loopDelay;
                    document.getElementById('bleScanPeriod').value = settings.bleScanPeriod;
                    document.getElementById('ignoreRandomBLE').checked = settings.ignoreRandomBLE;
                    document.getElementById('bleScanDuration').value = settings.bleScanDuration;
                    document.getElementById('operationMode').value = settings.operationMode;
                    document.getElementById('passiveScan').checked = settings.passiveScan;
                    document.getElementById('stealthMode').checked = settings.stealthMode;
                    document.getElementById('autosaveInterval').value = settings.autosaveInterval;
                    document.getElementById('deviceName').value = settings.deviceName;

                    updateOperationModeDisplay();

                    addLog('Settings read successfully');
                } catch (error) {
                    console.error('Error reading settings:', error);
                    addLog(`Error reading settings: ${error.message}`, true);
                }
            }

            const OFF_MODE = 0;
            const CAPTURE_MODE = 1;
            const DETECTION_MODE = 2;

            function updateOperationModeDisplay() {
                if(settings.operationMode == OFF_MODE) {
                    document.getElementById('status-mode').textContent = "‚ùå OFF";
                } else if(settings.operationMode == CAPTURE_MODE) {
                    document.getElementById('status-mode').textContent = "üé• CAPTURE";
                } else if(settings.operationMode == DETECTION_MODE) {
                    document.getElementById('status-mode').textContent = "üîç DETECTION";
                }
                
                // Update the operation buttons visibility
                if(settings.operationMode == OFF_MODE) {
                    offContainer.classList.remove('hidden');
                    captureContainer.classList.add('hidden');
                    detectionContainer.classList.add('hidden');
                } else if(settings.operationMode == CAPTURE_MODE) {
                    offContainer.classList.add('hidden');
                    captureContainer.classList.remove('hidden');
                    detectionContainer.classList.add('hidden');
                } else if(settings.operationMode == DETECTION_MODE) {
                    offContainer.classList.add('hidden');
                    captureContainer.classList.add('hidden');
                    detectionContainer.classList.remove('hidden');
                }

            }

            async function updateSettings() {
                try {
                    const onlyManagementFrames = document.getElementById('onlyManagementFrames').checked ? 1 : 0;
                    const minimalRSSI = parseInt(document.getElementById('minimalRSSI').value);
                    const loopDelay = parseInt(document.getElementById('loopDelay').value);
                    const bleScanPeriod = parseInt(document.getElementById('bleScanPeriod').value);
                    const ignoreRandomBLE = document.getElementById('ignoreRandomBLE').checked ? 1 : 0;
                    const bleScanDuration = parseInt(document.getElementById('bleScanDuration').value);
                    const operationMode = parseInt(document.getElementById('operationMode').value);
                    const passiveScan = document.getElementById('passiveScan').checked ? 1 : 0;
                    const stealthMode = document.getElementById('stealthMode').checked ? 1 : 0;
                    const autosaveInterval = parseInt(document.getElementById('autosaveInterval').value);
                    const deviceName = document.getElementById('deviceName').value;

                    const settingsString = `${onlyManagementFrames}:${minimalRSSI}:${loopDelay}:${bleScanPeriod}:${ignoreRandomBLE}:${bleScanDuration}:${operationMode}:${passiveScan}:${stealthMode}:${autosaveInterval}:${deviceName}`;

                    await settingsCharacteristic.writeValue(new TextEncoder().encode(settingsString));
                    addLog('Settings updated successfully');

                    await readSettings();
                } catch (error) {
                    console.error('Error updating settings:', error);
                    addLog(`Error updating settings: ${error.message}`, true);
                }
            }

            function handleDisconnection(event) {
                console.log('Device disconnected', event);
                addLog('Device disconnected unexpectedly', true);
                showDisconnectionModal();
                
                // Clear the status update interval
                clearInterval(statusInterval);
            }

            function showDisconnectionModal() {
                document.getElementById('disconnectionModal').style.display = 'block';
            }

            function closeModal() {
                document.getElementById('disconnectionModal').style.display = 'none';
                resetUI();
                showPage('#logon');
            }

            function showPage(pageId) {
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                document.querySelector(pageId).classList.add('active');

                // Ocultar o mostrar la navegaci√≥n dependiendo de la p√°gina
                if (pageId === '#logon') {
                    headerElement.classList.add('hidden');
                } else {
                    headerElement.classList.remove('hidden');
                }

                // Actualizar el enlace activo en la navegaci√≥n
                document.querySelectorAll('nav a').forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === pageId) {
                        link.classList.add('active');
                    }
                });
            }

            function resetUI() {
                searchDeviceBtn.style.display = 'inline-block';
                headerElement.classList.add('hidden');
                firmwareInfoElement.textContent = '';
                statusTitleElement.textContent = 'Current Status';
                
                // Clear the status update interval
                clearInterval(statusInterval);
            }

            function updateStatusTitle(deviceName) {
                statusTitleElement.textContent = `Firmware Information for ${deviceName}`;
            }

            // Vincular el bot√≥n de b√∫squeda a la funci√≥n de conexi√≥n
            searchDeviceBtn.addEventListener('click', connectToBLEDevice);

            // Agregar la navegaci√≥n
            document.querySelectorAll('nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(link.getAttribute('href'));
                });
            });

            getDataButton.addEventListener('click', () => getData('0000'));
            getRelevantDataButton.addEventListener('click', () => getData('0000Y'));
            copyButton.addEventListener('click', copyToClipboard);
            saveDataButton.addEventListener('click', () => sendCommand('save_data'));
            saveRelevantDataButton.addEventListener('click', () => sendCommand('save_relevant_data'));

            async function getData(initialPacket) {
                try {
                    jsonViewer.innerHTML = '';
                    progressBar.style.width = '0%';
                    progressContainer.style.display = 'block'; // Show the progress bar
                    receivedData = '';
                    currentPacket = 0;

                    await requestPacket(initialPacket);
                    addLog("Data transfer started");
                } catch (error) {
                    console.error('Error starting data transfer:', error);
                    addLog(`Error: ${error.message}`, true);
                }
            }

            async function requestPacket(packetNumber) {
                const packetRequestHex = typeof packetNumber === 'string' ? packetNumber : packetNumber.toString(16).padStart(4, '0').toUpperCase();
                await dataTransferCharacteristic.writeValue(new TextEncoder().encode(packetRequestHex));
            }

            function handleDataTransferNotification(event) {
                const value = new TextDecoder().decode(event.target.value);
                console.log("Received:", value);

                if (value.startsWith("START:")) {
                    totalPackets = parseInt(value.substring(6), 16);
                    addLog(`Transfer length: ${totalPackets} packets`);
                    currentPacket = 1;
                    requestPacket(currentPacket);
                } else if (value === "END") {
                    showData(receivedData);
                    addLog("Data transfer completed");
                    progressBar.style.width = '100%';

                    setTimeout(() => {
                        progressBar.style.width = '0%';
                        progressContainer.style.display = 'none'; // Hide the progress bar after completion
                    }, 1000);
                } else {
                    const packetNumber = parseInt(value.substring(0, 4), 16);
                    if (packetNumber === currentPacket) {
                        receivedData += value.substring(4);
                        updateProgress();
                        currentPacket++;
                        requestPacket(currentPacket);
                    } else {
                        console.error(`Received unexpected packet ${packetNumber}, expected ${currentPacket}`);
                    }
                }
            }

            function updateProgress() {
                const progress = (currentPacket / totalPackets) * 100;
                progressBar.style.width = `${progress}%`;
                addLog(`Received packet ${currentPacket} of ${totalPackets}`);
            }

            function showData(message) {
                try {
                    const jsonObject = JSON.parse(message);
                    const formattedJson = JSON.stringify(jsonObject, null, 2);
                    jsonViewer.innerHTML = syntaxHighlight(formattedJson);
                    jsonViewer.scrollTop = jsonViewer.scrollHeight;
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    jsonViewer.textContent = message;
                }
            }

            function syntaxHighlight(json) {
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    let cls = 'json-number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'json-key';
                        } else {
                            cls = 'json-string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'json-boolean';
                    } else if (/null/.test(match)) {
                        cls = 'json-null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }

            function copyToClipboard() {
                const textToCopy = jsonViewer.textContent;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalText = copyButton.textContent;
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    alert('Failed to copy text. Please try again.');
                });
            }

            function handleListSizesNotification(event) {
                const value = new TextDecoder().decode(event.target.value);
                const [ssids, stations, bleDevices] = value.split(':').map(Number);

                addLog(`List sizes updated - SSIDs: ${ssids}, Stations: ${stations}, BLE Devices: ${bleDevices}`);
                updateListSizesDisplay(ssids, stations, bleDevices);
            }

            function updateListSizesDisplay(ssids, stations, bleDevices) {
                const listSizesElement = document.getElementById('listSizes');
                listSizesElement.textContent = `SSIDs: ${ssids}, Stations: ${stations}, BLE Devices: ${bleDevices}`;
                listSizesElement.style.display = 'block';
            }

            async function sendCommand(command) {
                try {
                    await commandsCharacteristic.writeValue(new TextEncoder().encode(command));
                    addLog(`${command} command sent`);
                    showTooltip(`${command} command sent`);
                } catch (error) {
                    console.error(`Error sending ${command} command:`, error);
                    addLog(`Error: ${error.message}`, true);
                }
            }

            function showTooltip(message) {
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = message;
                document.body.appendChild(tooltip);

                // Force reflow
                tooltip.offsetHeight;

                // Show tooltip
                tooltip.classList.add('show');

                // Hide and remove tooltip after 3 seconds
                setTimeout(() => {
                    tooltip.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(tooltip);
                    }, 300);
                }, 3000);
            }

            updateSettingsButton.addEventListener('click', async () => {
                try {
                    await updateSettings();
                    addLog("Settings updated successfully");
                    showTooltip("Settings updated successfully");
                } catch (error) {
                    console.error('Error updating settings:', error);
                    addLog(`Error updating settings: ${error.message}`, true);
                    showTooltip("Error updating settings");
                }
            });

            async function readStatus() {
                try {
                    const value = await statusCharacteristic.readValue();
                    handleStatusUpdate(new TextDecoder().decode(value));
                    addLog('Status read successfully');
                } catch (error) {
                    console.error('Error reading status:', error);
                    addLog(`Error reading status: ${error.message}`, true);
                }
            }

            function handleStatusNotification(event) {
                const value = new TextDecoder().decode(event.target.value);
                handleStatusUpdate(value);
            }

            function handleStatusUpdate(statusString) {
                const [wifiNetworks, wifiDevices, bleDevices, alarm] = statusString.split(':');

                const operationMode = parseInt(document.getElementById('operationMode').value);
                const mode = operationMode == 0 ? "‚ùå OFF" : operationMode == 1 ? "üé• CAPTURE" : "üîç DETECTION";
                document.getElementById('status-mode').textContent = mode;

                document.getElementById('status-wifi-networks').textContent = wifiNetworks;
                document.getElementById('status-wifi-devices').textContent = wifiDevices;
                document.getElementById('status-ble-devices').textContent = bleDevices;

                document.getElementById('status-alarm').textContent = alarm ? "üî•" : "üü¢";


                addLog(`Status updated - WiFi Networks: ${wifiNetworks}, WiFi Devices: ${wifiDevices}, BLE Devices: ${bleDevices}${alarm ? `, Alarm: ${alarm}` : ''}`);
            }

            window.closeModal = closeModal;
            window.showPage = showPage;
            window.updateStatusTitle = updateStatusTitle;
            window.addLog = addLog;
            window.readFirmwareInfo = readFirmwareInfo;
            window.handleDisconnection = handleDisconnection;
            window.connectToBLEDevice = connectToBLEDevice;
            window.resetUI = resetUI;

            // Inicializar la UI
            resetUI();
        });
    </script>
</body>

</html>